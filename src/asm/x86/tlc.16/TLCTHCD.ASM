;;----------------------------------------------------------------------------
;;
;;       Copyright (c) 2017-2018 Frank Eskesen.
;;
;;       This file is free content, distributed under the GNU General
;;       Public License, version 3.0.
;;       (See accompanying file LICENSE.GPL-3.0 or the original
;;       contained within https://www.gnu.org/licenses/gpl-3.0.en.html)
;;
;;----------------------------------------------------------------------------
;;
;;
;; Title-
;;       TLCTHCD.ASM
;;
;; Purpose-
;;       Threaded Language Compiler (FORTH) Precompiliation
;;
;; Last change date-
;;       2018/09/30 Added license information.
;;
;;----------------------------------------------------------------------------
;
;        CODE THREAD VECTORS
;
TEXIT    DW    CEXIT
TNEXT    DW    CNEXT
TSTOP    DW    CSTOP

TPEEKW   DW    CPEEKW
TPOKEW   DW    CPOKEW
TPEEKC   DW    CPEEKC
TPOKEC   DW    CPOKEC

TEGET    DW    CEGET
TESET    DW    CESET
TPEEKWS  DW    CPEEKWS
TPOKEWS  DW    CPOKEWS
TPEEKCS  DW    CPEEKCS
TPOKECS  DW    CPOKECS
         PAGE
TEXEC    DW    CEXEC
TGOTO    DW    CGOTO
TIFEQZ   DW    CIFEQZ
TIFNEZ   DW    CIFNEZ
TIFLTZ   DW    CIFLTZ
TIFLEZ   DW    CIFLEZ
TIFGEZ   DW    CIFGEZ
TIFEQ    DW    CIFEQ
TIFLT    DW    CIFLT
TIFGE    DW    CIFGE
TIFNE    DW    CIFNE
TIFLTL   DW    CIFLTL
TIFGEL   DW    CIFGEL

TIMMW    DW    CIMMW
TPOP     DW    CPOP
TSWAP    DW    CSWAP
TOVER    DW    COVER
TDUP     DW    CDUP
TCLEAR   DW    CCLEAR
TRESET   DW    CRESET
TQUIT    DW    CQUIT
TAND     DW    CAND
TOR      DW    COR
TXOR     DW    CXOR
TNOT     DW    CNOT
TINC     DW    CINC
TDEC     DW    CDEC
TADD     DW    CADD
TSUB     DW    CSUB
TMUL     DW    CMUL
TDIV     DW    CDIV
TMOD     DW    CMOD
TDIVR    DW    CDIVR
TNEG     DW    CNEG
TMAXF    DW    CMAXF
TMINF    DW    CMINF
TABSF    DW    CABSF
TCLS     DW    CCLS
TMVS     DW    CMVS

TGET     DW    CGET
TINPC    DW    CINPC
TOUTC    DW    COUTC
TCVC     DW    CCVC

TAUXPUSH DW    CAUXPUSH
TAUXPOP  DW    CAUXPOP
TH@FORT  DW    CV@FORT
TH@I     DW    CV@I
TH@J     DW    CV@J
TH@K     DW    CV@K
         PAGE
;
;        CONSTANTS
;
TCVFF    DW    TCON,-1
TCV00    DW    TCON,00
TCV01    DW    TCON,01
TCV02    DW    TCON,02
TCV04    DW    TCON,04
TCV05    DW    TCON,05
TCV08    DW    TCON,08
TCV10    DW    TCON,10
TCV16    DW    TCON,16
MEMORY   DW    TCON,$-$
CVTTAB   DB    '0123456789ABCDEF'

;
;        VARIABLES
;
TBASE    DW    TVAR
BASE     DB    10,0

TPAD     DW    TVAR
         DB    128 DUP (?)

IMAGEA0  DW    TVAR
         DB    0,0
IMAGE    DB    128 DUP (?)

CFLAG    DW    TVAR
         DW    0

ACODE    DW    TVAR
         DW    @@ENDD

OCODE    DW    TVAR
         DW    $-$

AUXSTACK DW    0          ; AUXILLIARY STACK INDEX
         DW    64 DUP (0) ; AUXILLIARY STACK

CVPA0    DW    TVAR
         DB    40 DUP (?)

CVIVAL   DW    TVAR
         DW    0

CVISGN   DW    TVAR
         DB    0
         PAGE
;
;        VARIABLE CONTROL WORDS
;
BASEV    DW    TCALL,TBASE,TPEEKC,TEXIT
BASES    DW    TCALL,TBASE,TPOKEC,TEXIT

PADV0    DW    TCALL,TPAD,TPEEKC,TEXIT
PADS0    DW    TCALL,TPAD,TPOKEC,TEXIT

IMAGEA1  DW    TCON,IMAGE-1
IMAGEA2  DW    TCON,IMAGE-0
IMAGEV0  DW    TCALL,IMAGEA0,TPEEKC,TEXIT
IMAGEV1  DW    TCALL,IMAGEA1,TPEEKC,TEXIT
IMAGES0  DW    TCALL,IMAGEA0,TPOKEC,TEXIT
IMAGES1  DW    TCALL,IMAGEA1,TPOKEC,TEXIT

VCODE    DW    TCALL,ACODE,TPEEKW,TEXIT

CVPV0    DW    TCALL,CVPA0,TPEEKC,TEXIT
CVPS0    DW    TCALL,CVPA0,TPOKEC,TEXIT
         PAGE
;
;        TH@MAIN - MAINLINE CONTROL THREAD
;
TH@MAIN  DW    TMAIN,TPEEKW,TEXEC,TGOTO,TH@MAIN
TMAIN    DW    TVAR,TH@SCAN

;
;        TH@SCAN - CONSOLE SCAN ROUTINE
;
TH@SCAN  DW    TCALL,TIMMW,SCANM1,TPUT,TH@NXTL
SCAN1    DW    TH@NXTW,TIFEQZ,TH@EXIT
         DW    TH@CMNT,TIFNEZ,SCAN1
         DW    TSDICT,TPEEKW,TH@LOOK,TIFNEZ,SCAN2
         DW    TCVI,TIFNEZ,SCAN1
         DW    TIMMW,SCANM2,TPUT,TPUT,TEXIT
SCAN2    DW    TEXEC,TGOTO,SCAN1
SCANM1   DB    5,CH@NL,'TLC',CH@NL
SCANM2   DB    19,CH@NL,'UNDEFINED SYMBOL: '

;
;        TH@VAR - DEFINE VARIABLE
;
TH@VAR   DW    TCALL,TH@GETW,TH@NTER
         DW    TIMMW,TVAR,TH@CMPW,TH@CMPW,TEXIT

;
;        TH@CON - DEFINE CONSTANT
;
TH@CON   DW    TCALL,TH@GETW,TH@NTER
         DW    TIMMW,TCON,TH@CMPW,TH@CMPW,TEXIT

;
;        TH@CMPL - BEGIN COMPILATION MODE
;
TH@CMPL  DW    TCALL,TCV00,CFLAG,TPOKEW
         DW    TH@GETW,TH@NTER
         DW    TIMMW,TCALL,TH@CMPW
CMPL1    DW    TH@NXTW,TIFEQZ,CMPL6
         DW    TH@CMNT,TIFNEZ,CMPL1
         DW    TCDICT,TH@LOOK,TIFEQZ,CMPL2
         DW    TEXEC,TGOTO,CMPL5
CMPL2    DW    TSDICT,TPEEKW,TH@LOOK,TIFEQZ,CMPL3
         DW    TH@CMPW,TGOTO,CMPL5
CMPL3    DW    TCVI,TIFEQZ,CMPL4
         DW    TIMMW,TIMMW,TH@CMPW,TH@CMPW,TGOTO,CMPL5
CMPL4    DW    TIMMW,SCANM2,TPUT,TH@UERR
CMPL5    DW    CFLAG,TPEEKW,TIFEQZ,CMPL1,TEXIT

CMPL6    DW    TIMMW,CMPLM1,TPUT
         DW    TH@NXTL,TGOTO,CMPL1

CMPLM1   DB    3,CH@NL,':',CH@NL
         PAGE
;
;        TH@IF - SKIP CODE IF FALSE
;
TH@IF    DW    TCALL,TIMMW,TIFEQZ,TH@CMPW
         DW    VCODE,TCV00,TH@CMPW,TEXIT

;
;        TH@THEN - COMPLETE PREVIOUS IF OR ELSE
;
TH@THEN  DW    TCALL,VCODE,TSWAP,TPOKEW,TEXIT

;
;        TH@ELSE - COMPLETE PREVIOUS IF, GENERATE ELSE
;
TH@ELSE  DW    TCALL,TIMMW,TGOTO,TH@CMPW
         DW    VCODE,TCV00,TH@CMPW,TSWAP,VCODE
         DW    TSWAP,TPOKEW,TEXIT

;
;        TH@PEAT - TARGET FOR LOOP INSTRUCTION
;
TH@PEAT  DW    TCALL,VCODE,TEXIT

;
;        TH@TILL - TERMINATE LOOP IF TRUE
;
TH@TILL  DW    TCALL,TIMMW,TIFNEZ,TH@CMPW
         DW    VCODE,TCV00,TH@CMPW,TEXIT

;
;        TH@FOR - COMPILE BEGINNING OF FOR LOOP
;
TH@FOR   DW    TCALL,TIMMW,TH@FORI,TH@CMPW
         DW    VCODE,TIMMW,TH@FORT,TH@CMPW
         DW    TIMMW,TIFNEZ,TH@CMPW
         DW    VCODE,TCV00,TH@CMPW,TEXIT

;
;        TH@FORI - INITIALIZE FOR LOOP
;
TH@FORI  DW    TCALL
         DW    TSWAP,TINC,TAUXPUSH
         DW    TDEC,TAUXPUSH
         DW    TEXIT

;
;        TH@LOOP - TARGET FOR UNTIL, UNCONDITIONAL RETURN TO REPEAT
;
TH@LOOP  DW    TCALL,TIMMW,TGOTO,TH@CMPW
         DW    TSWAP,TH@CMPW
         DW    VCODE,TSWAP,TPOKEW,TEXIT
         PAGE
;
;        TH@UERR - CORRECT FOR COMPILATION ERROR
;
TH@UERR  DW    TCALL,TSDICT,TPEEKW,TPEEKW
         DW    TSDICT,TPOKEW
         DW    OCODE,TPEEKW,ACODE,TPOKEW,TH@CERR

;
;        TH@CERR - COMPILATION ERROR, RESET
;
TH@CERR  DW    TCALL,TPUT,TCVFF,CFLAG,TPOKEW,TRESET

;
;        TH@SEMI - TERMINATE A THREAD COMPILATION
;
TH@SEMI  DW    TCALL,TIMMW,TEXIT,TH@CMPW
         DW    TCVFF,CFLAG,TPOKEW,TEXIT
         PAGE
;
;        TH@GETW - GET NEXT COMPILATION WORD
;
TH@GETW  DW    TCALL
GETW1    DW    TH@NXTW,TIFNEZ,TH@EXIT
         DW    TH@NXTL,TGOTO,GETW1

;
;        TH@CMPW - COMPILE NEXT WORD
;
TH@CMPW  DW    TCALL,VCODE,TDUP,TCV02,TADD
         DW    TDUP,MEMORY,TIFGEL,CMPW1
         DW    ACODE,TPOKEW,TPOKEW,TEXIT
CMPW1    DW    TIMMW,NTERM1,TH@UERR

;
;        TH@LOOK - LOOKUP NEXT WORD IN INPUT IMAGE BUFFER
;
TH@LOOK  DW    TCALL
LOOK1    DW    TDUP,TIFEQZ,LOOK3
         DW    TOVER,TOVER,TCV04,TADD
         DW    TCLS,TIFEQZ,LOOK2
         DW    TPEEKW,TGOTO,LOOK1
LOOK2    DW    TSWAP,TPOP,TCV02,TADD,TPEEKW
         DW    TCV01,TEXIT
LOOK3    DW    TPOP,TCV00,TEXIT

;
;        TH@FIND - LOOKUP ADDRESS OF DICTIONARY ENTRY
;
TH@FIND  DW    TCALL
FIND1    DW    TDUP,TIFEQZ,FIND3
         DW    TOVER,TOVER,TCV04,TADD
         DW    TCLS,TIFEQZ,FIND2,TPEEKW
         DW    TGOTO,FIND1
FIND2    DW    TSWAP,TPOP,TCV01,TEXIT
FIND3    DW    TPOP,TCV00,TEXIT

;
;        TH@NTER - ENTER A NAME INTO THE DICTIONARY
;
TH@NTER  DW    TCALL,TSTOP,TH@CHKD,VCODE,OCODE,TPOKEW
         DW    TDUP,TPEEKC,TCV05,TADD
         DW    VCODE,TADD,TDUP,MEMORY,TIFGEL,NTER1
         DW    TSDICT,TPEEKW,VCODE,TPOKEW
         DW    VCODE,TSDICT,TPOKEW
         DW    TDUP,VCODE,TCV02,TADD,TPOKEW
         DW    ACODE,TPOKEW,OCODE,TPEEKW,TCV04,TADD
         DW    TSWAP,TMVS,TEXIT
NTER1    DW    TPOP,TPOP
         DW    TIMMW,NTERM1,TH@CERR,TEXIT
NTERM1   DB    16,CH@NL,'DICTIONARY FULL'
         PAGE
;
;        TH@CHKD - CHECK FOR DUPLICATE SYMBOL
;
TH@CHKD  DW    TCALL,TDUP,TSDICT,TPEEKW,TH@FIND,TIFEQZ,CHKD1
         DW    TPOP,TIMMW,CHKDM1,TPUT,TDUP,TPUT,TEXIT
CHKD1    DW    TPOP,TEXIT
CHKDM1   DB    19,CH@NL,'DUPLICATE SYMBOL: '

;
;        TH@FGET - PROCESS FORGET FUNCTION
;
TH@FGET  DW    TCALL,TH@GETW,TSDICT,TPEEKW,TH@FIND
         DW    TIFEQZ,FGET1
         DW    TDUP,TPEEKW,TSDICT,TPOKEW
         DW    ACODE,TPOKEW,TEXIT
FGET1    DW    TIMMW,SCANM2,TPUT,TPUT,TEXIT

;
;        TH@NXTL - GET NEW INPUT LINE
;
TH@NXTL  DW    TCALL,TIMMW,SIZE IMAGE,IMAGES0,IMAGEA0,TGET,TH@CR
         DW    TCV00,IMAGES0,TEXIT

;
;        TH@NXTW - GET NEXT WORD IN INPUT IMAGE BUFFER
;
TH@NXTW  DW    TCALL
NXTW1    DW    TH@NXTC,TIFEQZ,NXTW5
         DW    TDUP,TIMMW,' ',TIFNE,NXTW2
         DW    TPOP,TGOTO,NXTW1
NXTW2    DW    TCV00,PADS0
NXTW3    DW    PADV0,TINC,TDUP,PADS0,TPAD,TADD
         DW    TPOKEC,TH@NXTC,TIFEQZ,NXTW4
         DW    TDUP,TIMMW,' ',TIFNE,NXTW3,TPOP
NXTW4    DW    TPAD,TCV01,TEXIT
NXTW5    DW    TCV00,TEXIT

;
;        TH@NXTC - GET NEXT CHARACTER IN INPUT IMAGE BUFFER
;
TH@NXTC  DW    TCALL,IMAGEV0,IMAGEV1,TIFGE,NXCH1
         DW    IMAGEV0,IMAGEA2,TADD,TPEEKC
         DW    IMAGEV0,TINC,IMAGES0,TCV01,TEXIT
NXCH1    DW    TCV00,TEXIT
         PAGE
;
;        TCVP - CONVERT TOP USING CURRENT BASE
;
TCVP     DW    TCALL
         DW    TCV00,CVPS0
         DW    TDUP,TIFGEZ,CVP1
         DW    TNEG,TIMMW,'-'
         DW    CVPA0,TINC,TPOKEC,TCV01,CVPS0
CVP1     DW    TCVFF,TSWAP
CVP2     DW    TBASE,TPEEKC,TDIVR,TABSF,TSWAP
         DW    TDUP,TIFNEZ,CVP2,TPOP
CVP3     DW    TDUP,TIFLTZ,CVP4,TIMMW,CVTTAB,TADD
         DW    TPEEKC,CVPV0,TINC,TDUP,CVPS0,CVPA0,TADD
         DW    TPOKEC,TGOTO,CVP3
CVP4     DW    TPOP,CVPA0
TH@EXIT  DW    TEXIT

;
;        TCVI - CONVERT STRING TO INTEGER USING CURRENT BASE
;
TCVI     DW    TCALL
         DW    TCV00,CVISGN,TPOKEC
         DW    TCV00,CVIVAL,TPOKEW
         DW    TDUP,TDUP,TPEEKC,TGNC,TIFEQZ,CVIEX
         DW    TDUP,TIMMW,'+',TIFEQ,CVI1
         DW    TDUP,TIMMW,'-',TIFNE,CVI2
         DW    TCVFF,CVISGN,TPOKEC
CVI1     DW    TPOP,TGNC,TIFEQZ,CVIEX
CVI2     DW    TCVC,TIFEQZ,CVIE1,CVIVAL,TPEEKW,TBASE,TPEEKC
         DW    TMUL,TADD,CVIVAL,TPOKEW
         DW    TGNC,TIFNEZ,CVI2
         DW    TPOP,CVIVAL,TPEEKW,CVISGN,TPEEKC,TIFEQZ,CVI3,TNEG
CVI3     DW    TCVFF,TEXIT
CVIE1    DW    TPOP,TPOP
CVIEX    DW    TCV00,TEXIT

;
;        TGNC - GET NEXT CHARACTER FROM STRING
;
TGNC     DW    TCALL,TDUP,TIFLEZ,GNCEX
         DW    TDEC,TSWAP,TINC,TSWAP
         DW    TOVER,TPEEKC,TCVFF,TEXIT
GNCEX    DW    TPOP,TPOP,TCV00,TEXIT
         PAGE
;
;        TH@CR - WRITE CARRIAGE RETURN
;
TH@CR    DW    TCALL,TIMMW,CH@NL,TOUTC,TEXIT

;
;        TH@SP - WRITE SPACE
;
TH@SP    DW    TCALL,TIMMW,CH@SP,TOUTC,TEXIT

;
;        TPUT - WRITE AN OUTPUT LINE
;
TPUT     DW    TCALL
         DW    TDUP,TPEEKC
TPUT1    DW    TGNC,TIFEQZ,TH@EXIT,TOUTC,TGOTO,TPUT1

;
;        TH@CMNT - PROCESS COMMENT
;
TH@CMNT  DW    TCALL
         DW    TDUP,TIMMW,CMNTS
         DW    TCLS,TIFNEZ,TH@FALSE
         DW    TPOP

CMNT1    DW    TH@NXTW,TIFEQZ,CMNT2
         DW    TIMMW,CMNTE,TCLS
         DW    TIFNEZ,CMNT1
         DW    TGOTO,TH@TRUE

CMNT2    DW    TIMMW,CMNTM1,TPUT
         DW    TH@NXTL,TGOTO,CMNT1

CMNTS    DB    1,'('
CMNTE    DB    1,')'
CMNTM1   DB    9,CH@NL,'COMMENT',CH@NL

;
;        TH@EQZ - TEST FOR ZERO
;
TH@EQZ   DW    TCALL,TIFNEZ,TH@FALSE
TH@TRUE  DW    TCV01,TEXIT

;
;        TH@LTZ - TEST FOR LESS THAN ZERO
;
TH@LTZ   DW    TCALL,TIFLTZ,TH@TRUE
TH@FALSE DW    TCV00,TEXIT

;
;        TH@EQ - TEST FOR EQUAL
;
TH@EQ    DW    TCALL,TIFEQ,TH@TRUE
         DW    TGOTO,TH@FALSE

;
;        TH@LT - TEST FOR LESS THAN
;
TH@LT    DW    TCALL,TIFLT,TH@TRUE
         DW    TGOTO,TH@FALSE

;
;        TH@LTL - TEST FOR LOGICAL LESS THAN
;
TH@LTL   DW    TCALL,TIFLTL,TH@TRUE
         DW    TGOTO,TH@FALSE
         PAGE
;
;        TH@HEX - SET HEX BASE
;
TH@HEX   DW    TCALL,TCV16,BASES,TEXIT

;
;        TH@DEC - SET DECIMAL BASE
;
TH@DEC   DW    TCALL,TCV10,BASES,TEXIT

;
;        TH@OCT - SET OCTAL BASE
;
TH@OCT   DW    TCALL,TCV08,BASES,TEXIT

;
;        TH@BIN - SET BINARY BASE
;
TH@BIN   DW    TCALL,TCV02,BASES,TEXIT

;
;        TH@PRTD - CONVERT TOP TO DECIMAL, PRINT IT OUT
;
TH@PRTD  DW    TCALL,BASEV,TSWAP
         DW    TCV10,BASES,TH@PRTV
         DW    BASES,TEXIT

;
;        TH@PRTX - CONVERT TOP TO HEX, PRINT IT OUT
;
TH@PRTX  DW    TCALL,BASEV,TSWAP
         DW    TCV16,BASES,TH@PRTV
         DW    BASES,TEXIT

;
;        TH@TOP - CONVERT TOP USING CURRENT BASE, PRINT IT OUT
;
TH@TOP   DW    TCALL,TDUP,TH@PRTV,TEXIT

;
;        TH@PRTV - CONVERT TOP USING CURRENT BASE, PRINT IT OUT
;
TH@PRTV  DW    TCALL,TCVP,TPUT,TH@SP,TEXIT
         PAGE
;
;        TDEBUG - DEBUG UTILITY
;
TDEBUG   DW    TCALL
         DW    TIMMW,DEBUGM1,TPUT
         DW    TIMMW,DEBUGM2,TPUT
         DW    DEBUG1,TH@PRTX
         DW    TIMMW,DEBUGM3,TPUT
         DW    TDUP,TH@PRTX,TH@CR
         DW    TEXIT
DEBUG1   DW    CEBUG1
DEBUGM1  DB    7,'*DEBUG*'
DEBUGM2  DB    5,' PCR='
DEBUGM3  DB    5,' TOP='

;
;        TH@TEST - CURRENT TEST FUNCTION
;
TH@TEST  DW    TCALL
         DW    TDEBUG
         DW    TEXIT
